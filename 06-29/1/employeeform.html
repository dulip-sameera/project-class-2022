<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Form</title>

    <script>
      window.addEventListener("load", initialize);

      let ajax;
      let employees;
      let genders;

      function initialize() {
        btnClear.addEventListener("click", clearForm);
        btnSearch.addEventListener("click", btnSearchMC);
        btnSearchClear.addEventListener("click", btnSearchClearMC);

        btnDelete.setAttribute("disabled", "disabled");
        btnUpdate.setAttribute("disabled", "disabled");

        genders = get("./gendercontroller.php");
        fillCombo(genders, cmbGender, "name", "Select a gender");
        fillCombo(genders, cmbSearchGender, "name", "Select a gender");
        employees = get("./employeecontroller.php");
        fillTable(employees, tblMain, [
          "name",
          "age",
          function (e) {
            return e.gender.name;
          },
        ]);
      }

      function loadView() {
        fillTable();
      }

      function btnSearchMC() {
        const name = txtSearchName.value;
        const gender = JSON.parse(cmbSearchGender.value);

        let query = "";

        // if there is a name
        if (name !== "") {
          query += `name=${name}`;
        }

        // if there is a gender
        if (gender !== null) {
          if (name !== "") {
            // if there are both name and gender
            query += `&gender=${gender.id}`;
          } else {
            // if there isn't name
            query += `gender=${gender.id}`;
          }
        }

        // get the employees from the database using ajax request
        employees = get(`./employeecontroller.php?${query}`);
        console.log(employees);
      }

      // clears the search form
      function btnSearchClearMC() {
        txtSearchName.value = "";
        cmbSearchGender.value = null;
      }

      function fillTable(data, table, props) {
        for (let i = 0; i < data.length; i++) {
          const tr = document.createElement("tr");
          for (let j = 0; j < props.length; j++) {
            const td = document.createElement("td");
            td.textContent =
              typeof props[j] === "function"
                ? props[j](data[i])
                : data[i][props[j]];
            tr.appendChild(td);
          }

          const btn = document.createElement("input");
          const td = document.createElement("td");
          btn.type = "button";
          btn.value = "Modify";
          btn.addEventListener("click", () => {
            modify(data[i]);
          });
          td.appendChild(btn);
          tr.appendChild(td);

          table.children[1].appendChild(tr);
        }
      }

      function fillCombo(data, combo, prop, hint) {
        const option = document.createElement("option");
        option.textContent = hint;
        option.value = null;
        option.setAttribute("disabled", "disabled");
        option.setAttribute("selected", "selected");
        combo.appendChild(option);
        for (let i = 0; i < data.length; i++) {
          const option = document.createElement("option");
          option.textContent = data[i][prop];
          option.value = JSON.stringify(data[i]);
          combo.appendChild(option);
        }
      }

      function modify(employee) {
        let userConfirm = window.confirm(
          `Are you sure to modify this employee ${employee.name}`
        );

        if (userConfirm) {
          txtName.value = employee.name;
          txtAge.value = employee.age;
          cmbGender.value = JSON.stringify(employee.gender);

          btnAdd.setAttribute("disabled", "disabled");
          btnDelete.removeAttribute("disabled");
          btnUpdate.removeAttribute("disabled");
        }
      }

      function clearForm() {
        let userConfirm = window.confirm("Do you want to clear the form...");

        if (userConfirm) {
          txtName.value = "";
          txtAge.value = "";
          cmbGender.value = null;

          btnDelete.setAttribute("disabled", "disabled");
          btnUpdate.setAttribute("disabled", "disabled");
          btnAdd.removeAttribute("disabled");
        }
      }

      //Support Functions

      function get(url) {
        const http = new XMLHttpRequest();
        // made synchronous because the data will return only after data has received and without that data program cant continue properly
        http.open("GET", url, false);
        http.send();

        if (http.status === 200) {
          return JSON.parse(http.responseText);
        }

        return null;
      }
    </script>
  </head>
  <body>
    <h1>Employee Detail Manager</h1>

    <h3>===========================Search===========================</h3>
    <label for="txtSearchName">Name: </label
    ><input type="text" id="txtSearchName" size="20" /> <br /><br />
    <label for="cmbSearchGender">Gender: </label
    ><select id="cmbSearchGender"></select>
    <br /><br />
    <button id="btnSearch">Search</button>
    <button id="btnSearchClear">Clear</button>

    <h3>===========================View===========================</h3>

    <table id="tblMain" border="1">
      <thead>
        <tr>
          <th>Name</th>
          <th>Age</th>
          <th>Gender</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>===========================View===========================</h3>

    <label for="txtName">Name: </label
    ><input type="text" id="txtName" size="20" /><br /><br />
    <label for="txtAge">Age: </label
    ><input type="text" id="txtAge" size="20" /><br /><br />
    <label for="cmbGender">Gender: </label
    ><select id="cmbGender"></select
    ><br /><br />
    <button id="btnDelete">Delete</button>
    <button id="btnUpdate">Update</button>
    <button id="btnClear">Clear</button>
    <button id="btnAdd">Add</button>
  </body>
</html>
